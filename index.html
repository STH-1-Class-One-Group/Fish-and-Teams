<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fish and Teams</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script
      src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"
      integrity="sha384-lLe9t9o9V9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9zV9z"
      crossorigin="anonymous"
    ></script>

    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/theme.css" />

    <style>
      /* [ë‚šì‹œ ê²Œì„ ìŠ¤íƒ€ì¼ - ê¸°ì¡´ ìœ ì§€] */
      #minigame-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 10000;
        background: white;
      }
      .swiper {
        width: 100%;
        height: 100%;
      }
      .game-screen {
        width: 100%;
        height: 100%;
        position: relative;
        background: linear-gradient(
          to bottom,
          #c7e0fd 0%,
          #c7e0fd 35%,
          #01579b 55%,
          #01579b 100%
        );
        overflow: hidden;
      }
      /* ... (ì• ë‹ˆë©”ì´ì…˜, ë°°, íŒŒë„ CSSëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) ... */
      .wave-background,
      .wave-foreground {
        position: absolute;
        top: 50%;
        width: 100%;
        height: 55%;
      }
      .wave-background {
        z-index: 50;
      }
      .wave-foreground {
        z-index: 200;
        pointer-events: none;
      }
      .wave-canvas {
        position: absolute;
        width: 400vw;
        height: 400vw;
        left: -150vw;
        border-radius: 43%;
        animation: wave-rotate 20s infinite linear;
      }
      .wave-canvas.-one {
        background: #4fc3f7;
        opacity: 0.6;
        animation-duration: 15s;
        top: 10px;
      }
      .wave-canvas.-two {
        background: #0670d3;
        opacity: 0.6;
        animation-duration: 22s;
        animation-direction: reverse;
        top: 20px;
      }
      .wave-canvas.-three {
        background: #012d50;
        opacity: 0.4;
        animation-duration: 30s;
        top: 30px;
      }

      .boat-container {
        position: absolute;
        top: 45%;
        left: 50%;
        transform: translate(-50%, -90%);
        width: 480px;
        height: 320px;
        z-index: 150;
      }
      .boat {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 140px;
        background-color: #894f1c;
        border: 4px solid #5d3513;
        clip-path: polygon(0% 0%, 100% 0%, 85% 100%, 15% 100%);
      }
      .fisherman {
        position: absolute;
        bottom: 135px;
        left: 50%;
        transform: translate(calc(-50% + 180px), 40px);
        width: 280px;
        z-index: -1;
      }
      .fishing-line {
        position: absolute;
        width: 4px;
        background: #fff;
        height: 150px;
        transition: height 0.6s ease-in-out;
        z-index: 60;
      }
      .fishing-line.line-style-0 {
        top: -30px;
        right: -80px;
      }
      .fishing-line.line-style-1 {
        top: 25px;
        right: -78px;
      }
      .fish {
        position: absolute;
        bottom: -35px;
        left: -20px;
        display: none;
        font-size: 2.5rem;
        animation: struggle 0.2s infinite;
      }
      .team-info {
        position: absolute;
        top: 30px;
        left: 40px;
        text-align: left;
        z-index: 300;
      }
      .record-box {
        background: rgba(255, 255, 255, 0.9);
        border: 4px solid #333;
        padding: 20px;
        min-width: 250px;
        min-height: 150px;
        margin-top: 15px;
        font-size: 1.5rem;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      #game-result-overlay {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 400px;
        height: 250px;
        background: white;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        z-index: 10001;
        text-align: center;
      }

      /* [NEW] ìµœì¢… ê²°ê³¼ íŒì—…(ëª¨ë‹¬) ìŠ¤íƒ€ì¼ */
      #final-result-modal {
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ë°°ê²½ */
        z-index: 11000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        border-radius: 15px;
        padding: 20px;
        position: relative;
        overflow-y: auto;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .close-modal-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        background: none;
        border: none;
        font-weight: bold;
      }

      @keyframes wave-rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes struggle {
        0% {
          transform: rotate(-10deg);
        }
        100% {
          transform: rotate(10deg);
        }
      }
    </style>
  </head>
  <body class="ocean">
    <header>
      <h1 class="logo">
        <a href="index.html"><img src="/img/Signature.svg" alt="" /></a>
      </h1>
    </header>

    <main>
      <div class="add-banner-left"></div>
      <div class="container">
        <section class="members">
          <h2>Members</h2>
          <div
            class="manage-buttons"
            style="
              margin-bottom: 20px;
              display: flex;
              gap: 10px;
              justify-content: flex-end;
            "
          >
            <button
              onclick="addMember()"
              class="header-btn"
              style="background: #4a90e2; color: white"
            >
              ì¶”ê°€
            </button>
            <button
              onclick="modifyMember()"
              class="header-btn"
              style="background: #50c878; color: white"
            >
              ìˆ˜ì •
            </button>
            <button
              onclick="delMember()"
              class="header-btn"
              style="background: #ff6b6b; color: white"
            >
              ì‚­ì œ
            </button>
          </div>
          <div class="table">
            <ul class="table-row table-header">
              <li class="table-cells tc-checkbox center">
                <input type="checkbox" onclick="sumCheckbox(this)" />
              </li>
              <li class="table-cells tc-number">No</li>
              <li class="table-cells tc-etc">ì´ë¦„</li>
              <li class="table-cells tc-etc">ë‚˜ì´</li>
              <li class="table-cells tc-etc">ì„±ë³„</li>
              <li class="table-cells tc-etc">ëŠ¥ë ¥ì¹˜</li>
            </ul>
            <ul class="table-data scrollbar"></ul>
          </div>
        </section>

        <section>
          <h2>íŒ€ ë°°ì •</h2>
          <div class="flex flex-gap-20 align-center">
            <div class="flex align-center">
              <p class="text-bold">íŒ€ ìˆ˜</p>
              <input
                class="margin-left-10"
                type="number"
                id="input-team-count"
                value="2"
                min="2"
              /><span class="margin-left-5">ëª…</span>
            </div>
            <div class="flex align-center flex-gap-10">
              <p class="text-bold">ë°¸ëŸ°ìŠ¤</p>
              <ul class="flex flex-gap-10">
                <li class="flex flex-gap-5 align-center">
                  <input type="checkbox" id="chk-age" />
                  <p>ë‚˜ì´</p>
                </li>
                <li class="flex flex-gap-5 align-center">
                  <input type="checkbox" id="chk-gender" checked />
                  <p>ì„±ë³„</p>
                </li>
                <li class="flex flex-gap-5 align-center">
                  <input type="checkbox" id="chk-ability" checked />
                  <p>ëŠ¥ë ¥ì¹˜</p>
                </li>
              </ul>
            </div>
          </div>
          <div style="margin-top: 20px; display: flex; gap: 10px">
            <button
              id="btn-assign-teams"
              class="header-btn"
              style="background: #007bff; color: white"
            >
              âš–ï¸ ì¡°ê±´ë¶€ ë°°ì •
            </button>
            <button
              id="btn-random-teams"
              class="header-btn"
              style="background: #28a745; color: white"
            >
              ğŸ² ëœë¤ ë°°ì •
            </button>
          </div>
        </section>
      </div>
      <div class="add-banner-right"></div>
    </main>

    <div id="minigame-overlay">
      <div class="swiper mySwiper">
        <div class="swiper-wrapper" id="game-screens-wrapper"></div>
      </div>
      <div id="game-result-overlay">
        <h3 style="font-size: 24px; position: absolute; top: 30px; left: 50%; transform: translateX(-50%);">ğŸ£ ë°°ì • ì™„ë£Œ!</h3>
        <p
          style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #666;
          "
        >
          ëª¨ë“  íŒ€ì›ì„ ë‚šì•„ì˜¬ë ¸ìŠµë‹ˆë‹¤.
        </p>
        <button
          onclick="closeGameAndShowResult()"
          style="
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
          "
        >
          ê²°ê³¼ í™•ì¸í•˜ê¸°
        </button>
      </div>
    </div>

    <div id="final-result-modal">
      <div class="modal-content">
        <button class="close-modal-btn" onclick="closeResultModal()">âœ•</button>
        <h2
          style="
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
          "
        >
          ğŸ‰ íŒ€ ë°°ì • ê²°ê³¼
        </h2>
        <div
          id="team-result-content"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
          "
        ></div>
      </div>
    </div>

    <footer></footer>

    <script type="module" src="src/view/crud.js"></script>

    <script>
      // [Lock Status] ìŠ¤í˜ì´ìŠ¤ë°” ì—°íƒ€ ë°©ì§€ë¥¼ ìœ„í•œ í•µì‹¬ ë³€ìˆ˜
      let gameData = {
        teams: [],
        currentSwiper: null,
        // isFishing(ë‚šì‹œ ì• ë‹ˆë©”ì´ì…˜ ì¤‘) + isTransitioning(ìŠ¬ë¼ì´ë“œ ì´ë™ ì¤‘)
        // ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ trueë©´ ì…ë ¥ ì ê¸ˆ
        isFishing: false,
        isTransitioning: false,
        totalFished: 0,
        totalMembers: 0,
      };
      let fishInterval = null;

      // [ê²Œì„ ì‹œì‘]
      window.startFishingGame = function (calculatedTeams) {
        gameData.teams = calculatedTeams.map((members, idx) => ({
          teamName: `Team ${idx + 1}`,
          members: [...members],
        }));

        gameData.totalMembers = calculatedTeams.flat().length;
        gameData.totalFished = 0;

        // ì´ˆê¸°í™” ì‹œì ì—ëŠ” ëª¨ë“  ì ê¸ˆ í•´ì œ
        gameData.isFishing = false;
        gameData.isTransitioning = false;

        renderGameScreens();

        document.getElementById("minigame-overlay").style.display = "block";
        document.getElementById("game-result-overlay").style.display = "none";

        if (gameData.currentSwiper) gameData.currentSwiper.destroy();
        gameData.currentSwiper = new Swiper(".mySwiper", {
          allowTouchMove: false,
          loop: true,
          speed: 600, // ìŠ¬ë¼ì´ë“œ ì´ë™ ì†ë„ 0.6ì´ˆ
          observer: true,
          observeParents: true,
        });

        startFishLoop();
      };

      function startFishLoop() {
        if (fishInterval) clearInterval(fishInterval);
        if (window.popupFish) window.popupFish();
        fishInterval = setInterval(() => {
          if (window.popupFish) window.popupFish();
        }, 2000);
      }

      function stopFishLoop() {
        if (fishInterval) {
          clearInterval(fishInterval);
          fishInterval = null;
        }
      }

      function renderGameScreens() {
        const wrapper = document.getElementById("game-screens-wrapper");
        wrapper.innerHTML = gameData.teams
          .map((team, idx) => {
            // [ìˆ˜ì •] ì§ìˆ˜ëŠ” fishing_1.svg, í™€ìˆ˜ëŠ” fishing_2.svg
            const fishermanImg = idx % 2 === 0 ? "1" : "2";
            return `
                <div class="swiper-slide">
                    <div class="game-screen">
                        <div class="team-info">
                            <h2>${team.teamName}</h2>
                            <div class="record-box" id="record-${idx}">ëŒ€ê¸° ì¤‘...</div>
                        </div>
                        <div class="wave-background"><div class="wave-canvas -three"></div></div>
                        <div class="boat-container">
                            <div class="boat"></div>
                            <div class="fishing-line line-style-${idx % 2}" id="line-${idx}">
                                <div class="fish">ğŸŸ</div>
                            </div>
                            <img src="img/fishing_${fishermanImg}.svg" class="fisherman" onerror="this.style.display='none'">
                        </div>
                        <div class="wave-foreground">
                            <div class="wave-canvas -one"></div>
                            <div class="wave-canvas -two"></div>
                        </div>
                    </div>
                </div>`;
          })
          .join("");
      }

      function processFishing() {
        // [â˜…ì¤‘ìš”â˜…] 2ì¤‘ ì ê¸ˆ ì¥ì¹˜: ë‚šì‹œ ì¤‘ì´ê±°ë‚˜ ìŠ¬ë¼ì´ë“œ ì´ë™ ì¤‘ì´ë©´ ë¬´ì¡°ê±´ ë¦¬í„´
        if (gameData.isFishing || gameData.isTransitioning) return;

        // ì´ë¯¸ ë‹¤ ë‚šì•˜ìœ¼ë©´ ë¦¬í„´
        if (gameData.totalFished >= gameData.totalMembers) return;

        // 1. ë‚šì‹œ ì‹œì‘ (ì ê¸ˆ ON)
        gameData.isFishing = true;

        const idx = gameData.currentSwiper.realIndex;
        const activeSlide =
          gameData.currentSwiper.slides[gameData.currentSwiper.activeIndex];

        // ìŠ¬ë¼ì´ë“œê°€ ë¡œë”© ì•ˆëœ ê²½ìš° ë°©ì–´
        if (!activeSlide) {
          gameData.isFishing = false;
          return;
        }

        const line = activeSlide.querySelector(`.fishing-line`);
        const fish = activeSlide.querySelector(`.fish`);
        const record = document.getElementById(`record-${idx}`);

        // ë‚šì‹¯ì¤„ ë‚´ë¦¬ê¸°
        line.style.height = "420px";

        setTimeout(() => {
          fish.style.display = "block";
          line.style.height = "130px"; // ë‚šì•„ì˜¬ë¦¬ê¸°

          setTimeout(() => {
            const team = gameData.teams[idx];
            if (team.members.length > 0) {
              const member = team.members.shift();
              if (record.innerHTML === "ëŒ€ê¸° ì¤‘...") record.innerHTML = "";
              const item = document.createElement("div");
              item.innerHTML = `&nbsp;ğŸ£ <b>${member.name}</b> ì„±ê³µ!`;
              record.prepend(item);
              gameData.totalFished++;
            } else {
              alert("ì´ íŒ€ì€ ì´ë¯¸ ë§Œì„ ì…ë‹ˆë‹¤!");
              // ì˜ˆì™¸ ìƒí™©: ë§Œì„ ì´ë©´ ì ê¸ˆ í•´ì œí•´ì£¼ì–´ì•¼ í•¨
              gameData.isFishing = false;
              return;
            }

            setTimeout(() => {
              fish.style.display = "none";
              line.style.height = "150px";

              // [ê²°ì •ì˜ ìˆœê°„]
              if (gameData.totalFished >= gameData.totalMembers) {
                // ê²Œì„ ì¢…ë£Œ ì‹œ
                stopFishLoop();
                document.getElementById("game-result-overlay").style.display =
                  "block";
                gameData.isFishing = false; // ê²Œì„ ëë‚¬ìœ¼ë‹ˆ ì ê¸ˆ í•´ì œ
              } else {
                // ë‹¤ìŒ ì‚¬ëŒ ë‚šìœ¼ëŸ¬ ì´ë™ (ì ê¸ˆ ìœ ì§€ ìƒíƒœì—ì„œ ìŠ¬ë¼ì´ë“œ ì´ë™ ì‹œì‘)
                gameData.isTransitioning = true; // ì´ë™ ì ê¸ˆ ì¶”ê°€ ON
                gameData.currentSwiper.slideNext();

                // [â˜…í•µì‹¬â˜…] ìŠ¬ë¼ì´ë“œ ì´ë™ ì‹œê°„(600ms) + ì—¬ìœ ì‹œê°„(100ms)ì´ ì§€ë‚˜ì•¼ ì ê¸ˆ í•´ì œ
                setTimeout(() => {
                  gameData.isFishing = false;
                  gameData.isTransitioning = false;
                }, 700);
              }
            }, 800);
          }, 700);
        }, 800);
      }

      // ìŠ¤í˜ì´ìŠ¤ë°” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      window.addEventListener("keydown", (e) => {
        const overlay = document.getElementById("minigame-overlay");
        const resultOverlay = document.getElementById("game-result-overlay");

        // ì¡°ê±´: ê²Œì„ í™”ë©´ì´ ì¼œì ¸ìˆê³  + ê²°ê³¼ì°½ì´ ì•ˆ ë–´ê³  + (â˜…ì ê¸ˆ ìƒíƒœê°€ ì•„ë‹ ë•Œâ˜…)
        if (
          e.code === "Space" &&
          overlay.style.display === "block" &&
          resultOverlay.style.display !== "block" &&
          !gameData.isFishing &&
          !gameData.isTransitioning
        ) {
          e.preventDefault();
          processFishing();
        }
      });

      window.closeGameAndShowResult = function () {
        stopFishLoop();
        document.getElementById("minigame-overlay").style.display = "none";
        document.getElementById("final-result-modal").style.display = "flex";
      };

      window.closeResultModal = function () {
        document.getElementById("final-result-modal").style.display = "none";
      };
    </script>
  </body>
</html>
